name: Create Version Tag and Release

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'LunaUnitFrames.toc'
  workflow_dispatch:

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.version.outputs.tag_name }}
      addon_version: ${{ steps.version.outputs.addon_version }}
      interface: ${{ steps.version.outputs.interface }}
      tag_created: ${{ steps.check_tag.outputs.exists == 'false' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version info from TOC
        id: version
        run: |
          # Extract Interface version (game client version)
          INTERFACE=$(grep -E "^## Interface:" LunaUnitFrames.toc | sed 's/## Interface: *//')
          
          # Extract addon version
          ADDON_VERSION=$(grep -E "^## Version:" LunaUnitFrames.toc | sed 's/## Version: *//')
          
          # Create tag name: v{addon_version}-{interface}
          TAG_NAME="v${ADDON_VERSION}-${INTERFACE}"
          
          echo "interface=${INTERFACE}" >> $GITHUB_OUTPUT
          echo "addon_version=${ADDON_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          
          echo "Interface: ${INTERFACE}"
          echo "Addon Version: ${ADDON_VERSION}"
          echo "Tag Name: ${TAG_NAME}"

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "refs/tags/${{ steps.version.outputs.tag_name }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.version.outputs.tag_name }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag ${{ steps.version.outputs.tag_name }} does not exist"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Release ${{ steps.version.outputs.tag_name }}

          Addon Version: ${{ steps.version.outputs.addon_version }}
          Game Version: vanilla (Classic Era)
          Interface: ${{ steps.version.outputs.interface }}"
          
          git push origin "${{ steps.version.outputs.tag_name }}"
          
          echo "‚úÖ Created and pushed tag: ${{ steps.version.outputs.tag_name }}"

      - name: Skip tag creation
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "‚è≠Ô∏è Skipping tag creation - ${{ steps.version.outputs.tag_name }} already exists"

  build-package:
    runs-on: ubuntu-latest
    needs: create-tag
    if: needs.create-tag.outputs.tag_created == 'true'
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Fetch externals from pkgmeta
        run: |
          # Install dependencies for pkgmeta parsing
          sudo apt-get update
          sudo apt-get install -y subversion
          
          # Create libs directory if it doesn't exist
          mkdir -p libs
          
          echo "üì¶ Fetching external libraries..."
          
          # Parse .pkgmeta and clone/checkout externals
          if [ -f ".pkgmeta" ]; then
            # Simple extraction of git externals
            in_externals=false
            current_path=""
            
            while IFS= read -r line || [ -n "$line" ]; do
              # Check if we're in the externals section
              if echo "$line" | grep -q "^externals:"; then
                in_externals=true
                continue
              fi
              
              # Check if we've left the externals section
              if $in_externals && echo "$line" | grep -q "^[a-z]" && ! echo "$line" | grep -q "^  "; then
                in_externals=false
                continue
              fi
              
              if $in_externals; then
                # Match path lines like "  libs/LibStub:"
                if echo "$line" | grep -qE "^  [a-zA-Z].*:$"; then
                  current_path=$(echo "$line" | sed 's/^  //' | sed 's/:$//')
                fi
                
                # Match simple URL externals like "  libs/LibStub: https://..."
                if echo "$line" | grep -qE "^  [a-zA-Z].*: https?://"; then
                  path=$(echo "$line" | sed 's/^  //' | cut -d':' -f1)
                  url=$(echo "$line" | sed 's/^[^:]*: //')
                  
                  if echo "$url" | grep -q "wowace.com"; then
                    echo "  Fetching SVN: $path from $url"
                    svn export --force "$url" "$path" 2>/dev/null || echo "  ‚ö†Ô∏è Failed to fetch $path"
                  fi
                fi
                
                # Match git URL lines
                if echo "$line" | grep -qE "url:.*github.com"; then
                  url=$(echo "$line" | sed 's/.*url: *//')
                  
                  if [ -n "$current_path" ] && [ ! -d "$current_path/.git" ]; then
                    echo "  Fetching Git: $current_path from $url"
                    rm -rf "$current_path"
                    git clone --depth 1 "$url" "$current_path" 2>/dev/null || echo "  ‚ö†Ô∏è Failed to clone $current_path"
                  fi
                fi
              fi
            done < .pkgmeta
          fi
          
          echo "‚úÖ External libraries fetched"

      - name: Create release package
        id: package
        run: |
          VERSION="${{ needs.create-tag.outputs.tag_name }}"
          ADDON_NAME="LunaUnitFrames"
          PACKAGE_NAME="${ADDON_NAME}-${VERSION}"
          
          echo "üì¶ Creating package: ${PACKAGE_NAME}"
          
          # Create package directory
          mkdir -p "release/${ADDON_NAME}"
          
          # Copy addon files (excluding development files)
          rsync -av --progress . "release/${ADDON_NAME}/" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='release' \
            --exclude='.pkgmeta' \
            --exclude='README.md' \
            --exclude='GAME_VERSION.md' \
            --exclude='.gitignore' \
            --exclude='*.md' \
            --exclude='.editorconfig'
          
          # Remove .git directories from libs
          find "release/${ADDON_NAME}/libs" -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          find "release/${ADDON_NAME}/libs" -name ".gitignore" -delete 2>/dev/null || true
          
          # Create zip package
          cd release
          zip -r "../${PACKAGE_NAME}.zip" "${ADDON_NAME}"
          cd ..
          
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "package_file=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Package created: ${PACKAGE_NAME}.zip"
          ls -la "${PACKAGE_NAME}.zip"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.package_name }}
          path: ${{ steps.package.outputs.package_file }}
          retention-days: 30

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.tag_name }}
          name: "Luna Unit Frames ${{ needs.create-tag.outputs.tag_name }}"
          body: |
            ## Luna Unit Frames ${{ needs.create-tag.outputs.tag_name }}
            
            **Game Version:** vanilla (WoW Classic Era)
            **Interface:** ${{ needs.create-tag.outputs.interface }}
            **Addon Version:** ${{ needs.create-tag.outputs.addon_version }}
            
            ### Installation
            1. Download `${{ steps.package.outputs.package_file }}`
            2. Extract to your `World of Warcraft/_classic_era_/Interface/AddOns/` folder
            3. Restart WoW or reload your UI
            
            ### Compatibility
            This release is for **WoW Classic Era** (Patch 1.15.x) only.
          files: ${{ steps.package.outputs.package_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release skipped (not main branch)
        if: github.ref != 'refs/heads/main'
        run: |
          echo "üì¶ Package built and uploaded as artifact"
          echo "‚è≠Ô∏è GitHub Release skipped - only published from 'main' branch"
          echo "   Current branch: ${{ github.ref }}"
